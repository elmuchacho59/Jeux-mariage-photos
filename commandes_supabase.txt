-- Force l'utilisation du schéma PUBLIC pour cette session
SET search_path = public;

-- Crée la table pour stocker les missions
CREATE TABLE public.missions (
  id bigint PRIMARY KEY,
  fr text,
  es text
);

-- Crée la table pour les défis
CREATE TABLE public.challenges (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  text text UNIQUE
);

-- Crée la table pour les invités
CREATE TABLE public.guests (
  key text PRIMARY KEY,
  display text,
  password text
);

-- Crée la table pour les affectations de missions aux invités
CREATE TABLE public.assignments (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  invite_key text REFERENCES public.guests(key),
  challenge text,
  UNIQUE(invite_key, challenge)
);

-- Crée la table pour les paramètres généraux
CREATE TABLE public.settings (
  key text PRIMARY KEY,
  value jsonb
);

-- Crée la table pour les métadonnées des photos
CREATE TABLE public.uploads (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  invite_key text REFERENCES public.guests(key),
  slot int,
  url text,
  challenge_label text,
  approved boolean DEFAULT false,
  published boolean DEFAULT false,
  created_at timestamptz DEFAULT now(),
  approved_at timestamptz,
  published_at timestamptz,
  UNIQUE(invite_key, slot)
);

-- ####################################################################
-- # NOUVELLES COMMANDES À EXÉCUTER POUR INSÉRER LES DONNÉES PAR DÉFAUT #
-- ####################################################################

-- Insérer les paramètres par défaut
INSERT INTO public.settings (key, value)
VALUES
  ('accessMode', '"all"'),
  ('eventAccess', '{"required": false, "password": ""}')
ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value;

-- Insérer les défis par défaut (version française)
INSERT INTO public.challenges (text)
VALUES
  ('Un selfie avec les mariés'),
  ('Une photo d''un fou rire'),
  ('La plus belle danse'),
  ('Un bisous volé'),
  ('Un toast levé'),
  ('Les chaussures les plus stylées'),
  ('Un câlin collectif'),
  ('Un détail de décoration'),
  ('Le plus beau sourire'),
  ('Un moment inattendu')
ON CONFLICT (text) DO NOTHING;

-- Insérer quelques missions vides par défaut pour que l'interface fonctionne
INSERT INTO public.missions (id, fr, es)
VALUES
  (1, '', ''), (2, '', ''), (3, '', ''), (4, '', ''), (5, '', ''),
  (6, '', ''), (7, '', ''), (8, '', ''), (9, '', ''), (10, '', '')
ON CONFLICT (id) DO NOTHING;
