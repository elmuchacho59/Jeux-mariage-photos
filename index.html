<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mission Photo - Mariage</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%92%93%3C/text%3E%3C/svg%3E" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <main class="app">
      <header class="app__header">
        <div class="brand">
          <a href="/" style="text-decoration: none; color: inherit;">
            <h1>Hello, BINGO!</h1>
          </a>
          <p class="subtitle">S√©lectionne tes missions et partage tes photos üéâ</p>
        </div>
        <div class="header-actions">
          <div class="language-switcher">
            <button id="lang-fr" class="btn active" style="font-size: 1.5rem; padding: 0.25rem 0.5rem;">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 3 2"><path fill="#002395" d="M0 0h1v2H0z"/><path fill="#fff" d="M1 0h1v2H1z"/><path fill="#ED2939" d="M2 0h1v2H2z"/></svg>
            </button>
            <button id="lang-es" class="btn" style="font-size: 1.5rem; padding: 0.25rem 0.5rem;">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 3 2"><path fill="#C60B1E" d="M0 0h3v0.5H0z"/><path fill="#FFC400" d="M0 0.5h3v1H0z"/><path fill="#C60B1E" d="M0 1.5h3v0.5H0z"/></svg>
            </button>
          </div>
          <button id="go-gallery-btn" class="btn">Galerie</button>
          <button id="go-admin-btn" class="btn">Admin</button>
        </div>
      </header>

      <section class="guest-flow" id="guest-flow-section">
        <!-- Step 1: Welcome -->
        <div class="guest-flow__step active" id="step-welcome">
            <div class="card intro">
                <div class="intro__content">
                    <h2>Hello, BINGO! ‚ú®</h2>
                    <p class="subtitle">Entre ton pr√©nom et c'est parti !</p>
                    <div id="access-banner" class="alert hidden">Acc√®s r√©serv√© aux invit√©s. Entrez votre nom tel que list√©, et le mot de passe si requis.</div>
                    <div class="intro__form">
                        <label for="invite-name" class="sr-only">Nom de l'invit√©</label>
                        <input id="invite-name" class="input input-lg" type="text" placeholder="Ton pr√©nom (ex: L√©a)" list="invite-names" />
                        <button id="start-btn" class="btn primary btn-lg">Commencer</button>
                    </div>
                    <datalist id="invite-names"></datalist>
                    <div class="intro__form intro__form--pass hidden" id="event-pass-row">
                        <input id="event-pass" class="input input-lg" type="text" placeholder="Mot de passe √©v√®nement" />
                        <button id="event-pass-help" class="btn" type="button" title="Aide mot de passe">?</button>
                        <button id="event-pass-toggle" class="btn" type="button" aria-pressed="true" title="Masquer/Afficher">üëÅ</button>
                    </div>
                    <div class="intro__form intro__form--pass hidden" id="invite-pass-row">
                        <input id="invite-pass" class="input input-lg" type="text" placeholder="Mot de passe (JJ/MM/AAAA)" />
                        <button id="invite-pass-help" class="btn" type="button" title="Aide mot de passe">?</button>
                        <button id="invite-pass-toggle" class="btn" type="button" aria-pressed="true" title="Masquer/Afficher">üëÅ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Missions & Upload -->
        <div class="guest-flow__step" id="step-missions">
            <div class="card">
                <div class="invite-header">
                    <div>
                        <div class="invite-name" id="current-invite">Invit√©</div>
                        <div class="invite-progress"><span id="assigned-count">0</span>/2 missions assign√©es</div>
                    </div>
                    <div class="actions">
                        <button id="next-invite-btn" class="btn">Changer d'invit√©</button>
                    </div>
                </div>

                <div id="mission-selection-panel">
                    <div style="text-align: center; margin-bottom: 16px;">
                        <img src="card-illustration.svg" alt="Exemple de carte de jeu" style="max-width: 100%; border-radius: 8px; margin-bottom: 12px;">
                        <p class="helper">Regarde ta carte de jeu et s√©lectionne les deux num√©ros de mission qui t'ont √©t√© attribu√©s ci-dessous.</p>
                    </div>
                    <div class="card card--light" style="margin-bottom:8px;">
                        <h3>Choisir mes missions</h3>
                        <div class="row" style="gap:8px;">
                            <select id="mission1" class="input" title="Mission 1"></select>
                            <select id="mission2" class="input" title="Mission 2"></select>
                            <button id="mission-confirm-btn" class="btn primary">Valider</button>
                            <button id="mission-reset-btn" class="btn">R√©initialiser</button>
                        </div>
                        <div class="helper">Pour commencer, s√©lectionne les deux num√©ros de mission indiqu√©s sur ta carte de jeu.</div>
                    </div>
                </div>

                <div id="mission-display-panel" class="hidden">
                    <div id="mission-consignes" class="card card--light">
                        <h3>Mes missions</h3>
                        <div class="card card--light" style="margin-top:12px; text-align:center;">
                        <p>Super ! Maintenant, r√©alise ces deux missions photo pour tenter de remporter le prix du grand gagnant du "Hello, BINGO!" üèÜ</p>
                    </div>
                    </div>

                    <section class="card card--light upload" id="upload-section">
                        <h3>T√©l√©verse tes 2 photos</h3>
                        <div style="text-align: center; padding: 12px; background-color: var(--bg-primary); border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border-color);">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px; color: var(--primary-color);"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                          <span style="font-weight: 600; color: var(--text-primary);">√Ä toi de jouer, prends tes plus belles photos !</span>
                        </div>
                        <div class="upload__grid">
                            <div class="drop" data-slot="0">
                                <div class="drop__label" id="slot0-label">Mission 1</div>
                                <div class="drop__zone" id="slot0-zone">
                                    <input type="file" id="slot0-input" accept="image/*" class="drop__input" />
                                    
                                    <div class="drop__hint">Glisse une image ou clique</div>
                                    <img id="slot0-preview" class="drop__preview hidden" alt="Pr√©visualisation photo 1" />
                                </div>
                                <div class="drop__actions">
                                    <button id="slot0-gallery-btn" class="btn primary">Prendre une photo</button>
                                    <button id="slot0-clear" class="btn">Effacer</button>
                                </div>
                                <div class="frame-toggle-wrapper hidden" id="frame-toggle-wrapper-0" style="font-size: 14px; margin-top: 4px;">
                                  <input type="checkbox" id="frame-toggle-input-0" checked>
                                  <label for="frame-toggle-input-0">Appliquer le cadre</label>
                                </div>
                            </div>
                            <div class="drop" data-slot="1">
                                <div class="drop__label" id="slot1-label">Mission 2</div>
                                <div class="drop__zone" id="slot1-zone">
                                    <input type="file" id="slot1-input" accept="image/*" class="drop__input" />
                                    
                                    <div class="drop__hint">Glisse une image ou clique</div>
                                    <img id="slot1-preview" class="drop__preview hidden" alt="Pr√©visualisation photo 2" />
                                </div>
                                <div class="drop__actions">
                                    <button id="slot1-gallery-btn" class="btn primary">Prendre une photo</button>
                                    <button id="slot1-clear" class="btn">Effacer</button>
                                </div>
                                <div class="frame-toggle-wrapper hidden" id="frame-toggle-wrapper-1" style="font-size: 14px; margin-top: 4px;">
                                  <input type="checkbox" id="frame-toggle-input-1" checked>
                                  <label for="frame-toggle-input-1">Appliquer le cadre</label>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top:8px; justify-content:flex-end; gap:8px;">
                            <button id="submit-missions-btn" class="btn primary" disabled>Envoyer</button>
                        </div>
                        <div id="submission-msg" class="helper hidden">Missions envoy√©es üéâ Tu es au top !</div>
                        <div id="frame-toggle-wrapper" class="hidden" style="margin-top: 12px; display: flex; align-items: center; gap: 8px;">
                          <input type="checkbox" id="frame-toggle-input" checked>
                          <label for="frame-toggle-input">Appliquer le cadre photo</label>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div class="guest-flow__step" id="step-confirmation">
            <div class="card intro">
                <div class="intro__content">
                    <h2>Merci pour ta participation ! ‚ú®</h2>
                    <p class="subtitle">C'est dans la bo√Æte ! üì∏ Va vite voir le ma√Ætre du jeu pour faire valider tes photos et finaliser ta participation. Bonne chance !</p>
                    <div class="row" style="justify-content:center;">
                        <button id="confirmation-gallery-btn" class="btn primary">Voir la galerie</button>
                        <button id="confirmation-new-guest-btn" class="btn">Nouvel invit√©</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

      <section class="card hidden" id="admin-section">
        <div class="admin-header">
          <h2>Espace Admin</h2>
          <div class="actions">
            <button id="admin-refresh" class="btn">Rafra√Æchir</button>
            <button id="admin-copy" class="btn">Copier</button>
            <button id="admin-export" class="btn">Exporter CSV</button>
            <button id="admin-export-zip" class="btn">Exporter ZIP</button>
            <button id="admin-logout" class="btn danger">D√©connexion</button>
            <button id="admin-exit" class="btn primary">Retour</button>
          </div>
        </div>

        <div class="card card--light stats-grid">
          <div class="stat-card">
            <h4>Participants</h4>
            <div id="stats-participants" class="stat-value">0</div>
          </div>
          <div class="stat-card">
            <h4>Photos en attente</h4>
            <div id="stats-pending" class="stat-value">0</div>
          </div>
          <div class="stat-card">
            <h4>Photos publi√©es</h4>
            <div id="stats-published" class="stat-value">0</div>
          </div>
        </div>

        <div class="card card--light" style="margin-top:12px;">
          <h3>Photos (workflow)</h3>
          <div class="tabs">
            <button id="admin-tab-pending" class="tab active">En attente</button>
            <button id="admin-tab-published" class="tab">Publi√©es</button>
          </div>
          <div class="row" style="margin-bottom:8px;">
            <label class="helper">Trier par</label>
            <select id="admin-photo-sort" class="input input-sm">
              <option value="date_desc">Plus r√©cent d'abord</option>
              <option value="date_asc">Plus ancien d'abord</option>
              <option value="likes_desc">Plus de likes (publi√©es)</option>
            </select>
            <button id="admin-delete-all-photos" class="btn danger" style="margin-left:auto;">Supprimer toutes les photos</button>
          </div>
          <div id="admin-photos-pending">
            <table class="table">
              <thead>
                <tr>
                  <th>Miniature</th>
                  <th>Invit√©</th>
                  <th>Mission</th>
                  <th>Envoy√©e</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="admin-photos-pending-tbody"></tbody>
            </table>
          </div>
          <div id="admin-photos-published" class="hidden">
            <table class="table">
              <thead>
                <tr>
                  <th>Miniature</th>
                  <th>Invit√©</th>
                  <th>Mission</th>
                  <th>Publi√©e</th>
                  <th>Likes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="admin-photos-published-tbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card card--light" style="margin-bottom:12px;">
          <h3>Acc√®s invit√©s</h3>
          <div class="row" style="align-items:center; gap:12px;">
            <label class="helper">Qui peut acc√©der ?</label>
            <select id="access-mode" class="input input-sm">
              <option value="all">Tous (acc√®s ouvert)</option>
              <option value="guests_only">R√©serv√© aux invit√©s list√©s</option>
            </select>
          </div>
        </div>
        <div class="card card--light" style="margin-bottom:12px;">
          <h3>Acc√®s √©v√®nement</h3>
          <div class="row" style="align-items:center; gap:8px;">
            <label class="helper">Mot de passe obligatoire ?</label>
            <select id="event-required" class="input input-sm">
              <option value="no">Non</option>
              <option value="yes">Oui</option>
            </select>
            <input id="event-pass-admin" class="input" placeholder="Mot de passe √©v√®nement" />
            <button id="event-pass-save" class="btn primary">Enregistrer</button>
            <button id="admin-reset-settings" class="btn danger" title="R√©initialiser les param√®tres par d√©faut">R√©initialiser param√®tres</button>
          </div>
          <div class="helper">Conseil: utilisez un mot simple √† communiquer aux invit√©s (ex: un code li√© au mariage).</div>
        </div>
        <div class="card card--light" style="margin-bottom:12px;">
          <h3>Missions (1‚Äì10)</h3>
          <div class="missions-grid">
            <table class="table">
              <thead>
                <tr>
                  <th>N¬∞</th>
                  <th>Consigne (FR)</th>
                  <th>Consigne (ES)</th>
                </tr>
              </thead>
              <tbody id="missions-tbody"></tbody>
            </table>
            <div class="helper">Ces consignes seront propos√©es aux invit√©s selon le num√©ro de mission choisi.</div>
          </div>
          <div class="actions" style="margin-top:8px;">
            <button id="missions-save" class="btn primary">Enregistrer les missions</button>
          </div>
        </div>
        <div class="card card--light" style="margin-bottom:12px;">
          <h3>Invit√©s</h3>
          <div class="row" style="margin-bottom:8px;">
            <input id="admin-guest-name" class="input" placeholder="Nom de l'invit√©" />
            <input id="admin-guest-pass" class="input" placeholder="Mot de passe (optionnel)" />
            <button id="admin-guest-add" class="btn primary">Ajouter</button>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Invit√©</th>
                <th>Mot de passe</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="admin-guests-tbody"></tbody>
          </table>
        </div>

        <div class="card card--light" style="margin-bottom:12px;">
          <h3>Cadre Photo</h3>
          <div class="row" style="align-items:center; gap:12px;">
            <input type="file" id="frame-upload-input" accept="image/png" class="input">
            <button id="frame-save-btn" class="btn primary">Enregistrer</button>
            <button id="frame-delete-btn" class="btn danger">Supprimer</button>
          </div>
          <div class="helper">T√©l√©versez un cadre au format PNG avec une zone transparente. Il sera appliqu√© √† toutes les photos.</div>
          <div style="margin-top:12px;">
            <h4>Aper√ßu du cadre actuel :</h4>
            <img id="frame-preview-img" src="" alt="Aper√ßu du cadre" style="max-width:200px; border:1px solid var(--border-color); background: repeating-conic-gradient(#eee 0 25%, transparent 0 50%) 0 0 / 20px 20px;"/>
          </div>
        </div>

        <div class="admin-tools">
          <input id="admin-search" class="input" placeholder="Rechercher un invit√©‚Ä¶" />
        </div>
        <div class="actions" style="margin-top:8px;">
          <button id="admin-reset-all" class="btn danger" title="Effacer toutes les donn√©es locales">R√©initialiser tout</button>
        </div>
        <div class="card card--light" style="margin-top:12px;">
          <h3>Classement (temps de r√©alisation)</h3>
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Invit√©</th>
                <th>Temps</th>
              </tr>
            </thead>
            <tbody id="ranking-tbody"></tbody>
          </table>
        </div>
      </section>

      <section class="card hidden" id="gallery-section">
        <div class="admin-header">
          <h2 data-t="gallery">Galerie</h2>
          <div class="actions">
            <button id="gallery-exit" class="btn primary" data-t="back">Retour</button>
          </div>
        </div>
        <div id="gallery-placeholder" class="card card--light hidden" style="text-align: center; padding: 32px; margin-bottom: 12px;">
          <h3 data-t="galleryEmpty">L'album est encore vide !</h3>
          <p class="subtitle" data-t="galleryEmptySubtitle">Ch√®res invit√©es, √† vos appareils photo ! La galerie attend vos chefs-d'≈ìuvre. üì∏</p>
        </div>
        <div id="gallery-columns" class="gallery-columns" style="margin-bottom:12px;"></div>
        
      </section>

      <div id="lightbox" class="lightbox hidden" aria-modal="true" role="dialog">
        <div class="lightbox__backdrop" id="lightbox-backdrop"></div>
        <div class="lightbox__content" role="document">
          <img id="lightbox-img" class="lightbox__img" alt="Agrandissement" />
          <div id="lightbox-caption" class="lightbox__caption"></div>
          <div class="lightbox__actions">
            <a id="lightbox-download" class="btn primary" download data-t="download">T√©l√©charger</a>
            <button id="lightbox-close" class="btn" data-t="close">Fermer</button>
          </div>
        </div>
      </div>

      <footer class="footer">
        
        <small>Fait avec amour ‚ù§Ô∏è par Christina et Vincent √† Paris</small>
      </footer>
    </main>

    <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>
    <canvas id="confetti-canvas" class="confetti" width="0" height="0" aria-hidden="true"></canvas>

    <div id="loading-overlay" class="loading-overlay hidden">
      <div class="spinner"></div>
    </div>

    <script src="./app.js" type="module"></script>
    <script src="./supabase-client.js" type="module"></script>
  </body>
</html>
